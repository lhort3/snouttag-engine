<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Owner - Access Code</title>
  <style>
    body{margin:0;background:#ffffff;color:#222;font:16px system-ui,Segoe UI,Roboto,Helvetica,Arial;display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
    .card{max-width:600px;background:#fff;border:2px solid #5790f6;border-radius:20px;padding:32px;box-shadow:0 8px 30px rgba(0,0,0,.1);text-align:center}
    h1{margin-top:0;font-size:28px;font-weight:800;color:#5790f6}
    p{line-height:1.5;color:#444;text-align:left}
    .code{font-size:64px;letter-spacing:10px;font-weight:900;margin:20px 0;background:#f5f8ff;border:2px solid #5790f6;border-radius:16px;padding:20px 10px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;color:#5790f6}
    .small{font-size:14px;color:#666;margin-top:16px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Your one-time Address PIN</h1>
    <div id="code" class="code">000000</div>
    <p>
      This is a secure service provided by SnoutTag. When somebody locates your pet and need to see the address they will be asked for a 6-digit code.
    </p>
    <p>
      This is the code shown on-screen. If you trust the person, read them the code over the phone. They will enter it on their device, revealing your linked home address.
    </p>
    <p>
      While significant safety measures have been put in place, like a 3 minute limit, this system is just a tool, do not use it solely to trust the person.
    </p>
    <div class="small" id="countdown">Time left: 00:00</div>
  </div>

<script>
(()=>{
  const STEP_SECONDS = 180; // 3 minutes
  const DIGITS = 6;

  const ub64 = (s)=>Uint8Array.from(atob(s), c=>c.charCodeAt(0));
  let secret_b64 = "u5wKJdMspDDf6UxFKkG4ObMpg20SZg9uHxOMBrHDnfc=";

  async function hmacSha256(keyBytes, msgBytes){
    const key = await crypto.subtle.importKey("raw", keyBytes, {name:"HMAC", hash:"SHA-256"}, false, ["sign"]);
    const sig = await crypto.subtle.sign("HMAC", key, msgBytes);
    return new Uint8Array(sig);
  }

  function counterFor(timeMs){
    return Math.floor(timeMs/1000/STEP_SECONDS);
  }

  function intTo8Bytes(num){
    const b = new Uint8Array(8);
    for(let i=7;i>=0;i--){ b[i] = num & 0xff; num = Math.floor(num/256); }
    return b;
  }

  function truncateToDigits(hmacBytes, digits){
    const offset = hmacBytes[hmacBytes.length-1] & 0x0f;
    const p = ((hmacBytes[offset] & 0x7f) << 24) | ((hmacBytes[offset+1] & 0xff) << 16) | ((hmacBytes[offset+2] & 0xff) << 8) | (hmacBytes[offset+3] & 0xff);
    const mod = 10 ** digits;
    return String(p % mod).padStart(digits, "0");
  }

  async function codeForCounter(secretBytes, counter){
    const msg = intTo8Bytes(counter);
    const mac = await hmacSha256(secretBytes, msg);
    return truncateToDigits(mac, DIGITS);
  }

  function fmtCountdown(ms){
    const s = Math.max(0, Math.floor(ms/1000));
    const m = Math.floor(s/60);
    const r = s%60;
    return `${String(m).padStart(2,"0")}:${String(r).padStart(2,"0")}`;
  }

  async function refresh(){
    const now = Date.now();
    const ctr = counterFor(now);
    const windowStart = ctr*STEP_SECONDS*1000;
    const msLeft = windowStart + STEP_SECONDS*1000 - now;

    const secret = ub64(secret_b64);
    const code = await codeForCounter(secret, ctr);

    document.getElementById("code").textContent = code;
    document.getElementById("countdown").textContent = "Time left: " + fmtCountdown(msLeft);
  }

  refresh();
  setInterval(refresh, 1000);
})();
</script>
</body>
</html>
